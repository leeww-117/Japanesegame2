<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>äº”åéŸ³é“å ´</title>
    <!-- å¼•å…¥æ—¥ç³»é¢¨æ ¼å­—é«” -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&family=Zen+Antique&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-paper: #f9f7f2; /* å’Œç´™è‰² */
            --ink-black: #2b2b2b; /* å¢¨è‰² */
            --torii-red: #c93a40; /* é³¥å±…ç´… */
            --indigo-blue: #2d4059; /* é›è— */
            --gold-accent: #d4af37;
            --success-color: #ef474d; /* æ‰¹æ”¹åœˆåœˆç´… */
            --text-main: #333;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: #222; /* ç€è¦½å™¨èƒŒæ™¯æ·±è‰²ï¼Œå‡¸é¡¯æ‰‹æ©Ÿæ¡† */
            font-family: 'Zen Antique', 'Noto Serif JP', serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: var(--text-main);
        }

        /* æ‰‹æ©Ÿæ¨¡æ“¬å®¹å™¨ */
        #app-container {
            width: 100%;
            max-width: 414px; /* iPhone Max å¯¬åº¦ */
            height: 100vh;
            max-height: 896px;
            background-color: var(--bg-paper);
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23dcd6cb' fill-opacity='0.25'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }

        /* è£é£¾å…ƒç´  */
        .decoration-top {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 8px;
            background: repeating-linear-gradient(45deg, var(--indigo-blue), var(--indigo-blue) 10px, var(--bg-paper) 10px, var(--bg-paper) 20px);
            z-index: 10;
        }

        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.4s ease, transform 0.4s ease;
            opacity: 0;
            pointer-events: none;
            transform: scale(0.95);
        }

        .screen.active {
            opacity: 1;
            pointer-events: all;
            transform: scale(1);
            z-index: 5;
        }

        /* æ¨™é¡Œæ¨£å¼ */
        h1 {
            font-size: 3rem;
            color: var(--ink-black);
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 0 rgba(200, 0, 0, 0.1);
            letter-spacing: 0.2rem;
            text-align: center;
        }

        .subtitle {
            font-size: 1rem;
            color: var(--torii-red);
            letter-spacing: 0.3rem;
            margin-bottom: 3rem;
            border-top: 1px solid var(--torii-red);
            border-bottom: 1px solid var(--torii-red);
            padding: 5px 15px;
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn-group {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }

        .btn {
            background: transparent;
            border: 2px solid var(--indigo-blue);
            color: var(--indigo-blue);
            padding: 12px 30px;
            font-size: 1.1rem;
            border-radius: 50px;
            cursor: pointer;
            width: 80%;
            font-family: inherit;
            font-weight: bold;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .btn span {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-bottom: 2px;
        }

        .btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 0%;
            height: 100%;
            background: var(--indigo-blue);
            transition: width 0.3s;
            z-index: -1;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn.primary {
            background: var(--torii-red);
            border-color: var(--torii-red);
            color: white;
            box-shadow: 0 4px 15px rgba(201, 58, 64, 0.4);
        }

        .btn.special {
            background: var(--indigo-blue);
            color: white;
            border-color: var(--indigo-blue);
        }

        /* éŠæˆ²ä»‹é¢ - é€šç”¨ */
        .game-header {
            position: absolute;
            top: 20px;
            width: 100%;
            padding: 0 25px;
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            color: var(--indigo-blue);
            font-size: 1.2rem;
            z-index: 20;
        }

        /* æ¨¡å¼ A: å–®å­—å¡ (å¤§å­— + 4é¸é …) */
        .card-wrapper {
            width: 200px;
            height: 200px;
            perspective: 1000px;
            margin-bottom: 20px;
            position: relative;
            display: none; /* é è¨­éš±è—ï¼Œè¦–æ¨¡å¼é–‹å•Ÿ */
        }
        .card-wrapper.active { display: block; }

        .card {
            width: 100%;
            height: 100%;
            background: white;
            border-radius: 20px;
            border: 4px solid var(--indigo-blue);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 6rem;
            box-shadow: 10px 10px 0 rgba(45, 64, 89, 0.15);
            position: relative;
        }

        /* èªéŸ³æŒ‰éˆ• */
        .audio-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--indigo-blue);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin: 0 auto 20px auto;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            font-size: 1.2rem;
            transition: transform 0.1s;
        }
        .audio-btn:active { transform: scale(0.9); }

        .options-grid {
            display: none;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            width: 100%;
            max-width: 340px;
        }
        .options-grid.active { display: grid; }

        .option-btn {
            background: white;
            border: 1px solid #ddd;
            padding: 20px;
            font-size: 1.5rem;
            border-radius: 12px;
            color: var(--text-main);
            font-family: inherit;
            cursor: pointer;
            transition: background 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .option-btn:active { background: #f0f0f0; }

        /* æ¨¡å¼ B: æ‹¼å¥ (å¥å­ + æ‹¼åœ–) */
        .sentence-wrapper {
            display: none;
            flex-direction: column;
            align-items: center;
            width: 100%;
            margin-bottom: 10px;
        }
        .sentence-wrapper.active { display: flex; }

        .sentence-display {
            font-size: 2.2rem;
            color: var(--indigo-blue);
            margin-bottom: 5px;
            font-weight: bold;
            text-align: center;
        }
        .sentence-meaning {
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 20px;
        }

        .answer-area {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            min-height: 60px;
            justify-content: center;
            margin-bottom: 20px;
            padding: 10px;
            border-bottom: 2px dashed #ccc;
            width: 100%;
        }

        .word-pool {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            width: 100%;
            max-width: 380px;
            overflow-y: auto;
            max-height: 200px;
        }

        .word-chip {
            background: white;
            border: 2px solid var(--indigo-blue);
            color: var(--indigo-blue);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 3px 0 rgba(45, 64, 89, 0.2);
            transition: transform 0.1s;
        }
        .word-chip:active {
            transform: translateY(3px);
            box-shadow: none;
        }
        .word-chip.used {
            opacity: 0;
            pointer-events: none;
        }
        
        /* æ”¾åœ¨ç­”æ¡ˆå€çš„æ¨£å¼ */
        .answer-chip {
            background: var(--torii-red);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        @keyframes popIn {
            from { transform: scale(0); }
            to { transform: scale(1); }
        }

        /* å°éŒ¯åé¥‹å±¤ */
        .feedback-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            font-size: 10rem;
            z-index: 20;
            opacity: 0;
            pointer-events: none;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s;
        }

        .feedback-overlay.correct {
            color: var(--success-color); /* ç´…åœˆ */
            border: 8px solid var(--success-color);
            border-radius: 50%;
            width: 160px;
            height: 160px;
        }

        .feedback-overlay.wrong {
            color: var(--indigo-blue);
        }
        .feedback-overlay.wrong::before, .feedback-overlay.wrong::after {
            content: '';
            position: absolute;
            width: 140px;
            height: 10px;
            background: var(--indigo-blue);
            border-radius: 5px;
        }
        .feedback-overlay.wrong::before { transform: rotate(45deg); }
        .feedback-overlay.wrong::after { transform: rotate(-45deg); }

        /* éŒ¯èª¤ç­”æ¡ˆé¡¯ç¤ºå€ */
        .correction-box {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 20px;
            border-radius: 10px;
            border: 2px solid var(--torii-red);
            color: var(--torii-red);
            font-weight: bold;
            text-align: center;
            width: 80%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 30;
        }
        .correction-box.visible { opacity: 1; }
        .correction-label { font-size: 0.9rem; color: #666; display: block; margin-bottom: 5px; }
        .correction-text { font-size: 1.5rem; }

        /* é€²åº¦æ¢ */
        .progress-container {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 6px;
            background: #e0e0e0;
        }
        .progress-bar {
            height: 100%;
            background: var(--torii-red);
            width: 0%;
            transition: width 0.3s ease;
        }

        /* çµç®—ç•«é¢ */
        .score-circle {
            width: 180px;
            height: 180px;
            border: 5px solid var(--torii-red);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin: 20px 0 40px 0;
            color: var(--torii-red);
            background: white;
            mask-image: url("data:image/svg+xml;utf8,<svg width='100%' height='100%' xmlns='http://www.w3.org/2000/svg'><filter id='noise'><feTurbulence type='fractalNoise' baseFrequency='0.8' result='noise'/><feColorMatrix type='matrix' values='1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 0.6 0' in='noise' result='coloredNoise'/><feComposite operator='in' in='coloredNoise' in2='SourceGraphic' result='composite'/></filter><rect width='100%' height='100%' fill='white'/></svg>");
        }

        .score-num {
            font-size: 4rem;
            font-weight: bold;
            line-height: 1;
        }
        .score-label {
            font-size: 1rem;
            margin-top: 5px;
        }

        .rank-text {
            font-size: 1.5rem;
            color: var(--indigo-blue);
            margin-bottom: 40px;
            font-weight: bold;
        }

        /* æ«»èŠ±å‹•ç•« (ç´”CSS) */
        .sakura {
            position: absolute;
            background-color: #ffd7e6;
            width: 10px;
            height: 10px;
            border-radius: 10px 0px;
            z-index: 1;
            opacity: 0.6;
            animation: fall linear infinite;
        }

        @keyframes fall {
            0% { top: -10%; transform: rotate(0deg) translateX(0); }
            100% { top: 110%; transform: rotate(360deg) translateX(50px); }
        }

    </style>
</head>
<body>

<div id="app-container">
    <div class="decoration-top"></div>
    
    <!-- æ«»èŠ±å®¹å™¨ -->
    <div id="sakura-container"></div>

    <!-- 1. é¦–é /é¸å–® -->
    <div id="screen-home" class="screen active">
        <h1>äº”åéŸ³<br>é“å ´</h1>
        <div class="subtitle">æ—¥æœ¬èªã®ç·´ç¿’</div>
        
        <div class="btn-group">
            <button class="btn" onclick="game.start('easy')">
                <span>å…¥é–€</span>
                åˆç´š (å¹³å‡å)
            </button>
            <button class="btn" onclick="game.start('medium')">
                <span>åŸºç¤</span>
                ä¸­ç´š (ç‰‡å‡å)
            </button>
            <button class="btn primary" onclick="game.start('hard')">
                <span>é”äºº</span>
                ä¸Šç´š (æ··åˆ+æ¿éŸ³)
            </button>
            <button class="btn special" onclick="game.start('sentence')">
                <span>å¯¦æˆ°</span>
                è©å½™æ‹¼å¯« (æ’åº)
            </button>
        </div>
    </div>

    <!-- 2. éŠæˆ²é€²è¡Œä¸­ -->
    <div id="screen-game" class="screen">
        <div class="game-header">
            <span id="label-mode">åˆç´š</span>
            <span><span id="score-current">0</span> Pt</span>
        </div>

        <!-- èªéŸ³æŒ‰éˆ• (æ”¾åœ¨å¡ç‰‡ä¸Šæ–¹æˆ–é¡Œç›®æ—) -->
        <button id="btn-audio" class="audio-btn" onclick="game.speakCurrent()">
            ğŸ”Š
        </button>

        <!-- æ¨¡å¼ A: å–®å­—è¾¨è­˜ -->
        <div id="wrapper-single" class="card-wrapper">
            <div class="card">
                <span id="q-char">ã‚</span>
            </div>
        </div>

        <!-- æ¨¡å¼ B: å¥å­æ‹¼å¯« -->
        <div id="wrapper-sentence" class="sentence-wrapper">
            <div class="sentence-display" id="s-kana">ã‚ã‚ŠãŒã¨ã†</div>
            <div class="sentence-meaning" id="s-meaning">è¬è¬</div>
            
            <div class="answer-area" id="s-answer-area">
                <!-- ç©å®¶é¸çš„å­—æœƒå‡ºç¾åœ¨é€™ -->
            </div>
            <div class="word-pool" id="s-pool">
                <!-- äº‚åºçš„æŒ‰éˆ• -->
            </div>
        </div>

        <!-- æ­£ç¢º/éŒ¯èª¤å‹•ç•«å±¤ -->
        <div id="feedback-icon" class="feedback-overlay"></div>

        <!-- éŒ¯èª¤ç­”æ¡ˆæç¤º -->
        <div id="correction-box" class="correction-box">
            <span class="correction-label">æ­£è§£ã¯</span>
            <span id="correction-text" class="correction-text">Answer</span>
        </div>

        <!-- æ¨¡å¼ A çš„é¸é … -->
        <div class="options-grid" id="options-box">
            <!-- JS å‹•æ…‹ç”ŸæˆæŒ‰éˆ• -->
        </div>

        <div class="progress-container">
            <div id="progress-bar" class="progress-bar"></div>
        </div>
    </div>

    <!-- 3. çµç®—ç•«é¢ -->
    <div id="screen-result" class="screen">
        <h2>ä¿®ç·´çµ‚äº†</h2>
        
        <div class="score-circle">
            <span class="score-num" id="score-final">80</span>
            <span class="score-label">é»</span>
        </div>

        <div class="rank-text" id="rank-text">
            ã‚ˆãã§ãã¾ã—ãŸï¼
        </div>

        <div class="btn-group">
            <button class="btn primary" onclick="ui.showScreen('home')">è¿”å›é“å ´</button>
        </div>
    </div>
</div>

<script>
    // --- è³‡æ–™åº« ---
    const KANA_DATA = {
        hiragana: [
            {c:'ã‚', r:'a'}, {c:'ã„', r:'i'}, {c:'ã†', r:'u'}, {c:'ãˆ', r:'e'}, {c:'ãŠ', r:'o'},
            {c:'ã‹', r:'ka'}, {c:'ã', r:'ki'}, {c:'ã', r:'ku'}, {c:'ã‘', r:'ke'}, {c:'ã“', r:'ko'},
            {c:'ã•', r:'sa'}, {c:'ã—', r:'shi'}, {c:'ã™', r:'su'}, {c:'ã›', r:'se'}, {c:'ã', r:'so'},
            {c:'ãŸ', r:'ta'}, {c:'ã¡', r:'chi'}, {c:'ã¤', r:'tsu'}, {c:'ã¦', r:'te'}, {c:'ã¨', r:'to'},
            {c:'ãª', r:'na'}, {c:'ã«', r:'ni'}, {c:'ã¬', r:'nu'}, {c:'ã­', r:'ne'}, {c:'ã®', r:'no'},
            {c:'ã¯', r:'ha'}, {c:'ã²', r:'hi'}, {c:'ãµ', r:'fu'}, {c:'ã¸', r:'he'}, {c:'ã»', r:'ho'},
            {c:'ã¾', r:'ma'}, {c:'ã¿', r:'mi'}, {c:'ã‚€', r:'mu'}, {c:'ã‚', r:'me'}, {c:'ã‚‚', r:'mo'},
            {c:'ã‚„', r:'ya'}, {c:'ã‚†', r:'yu'}, {c:'ã‚ˆ', r:'yo'},
            {c:'ã‚‰', r:'ra'}, {c:'ã‚Š', r:'ri'}, {c:'ã‚‹', r:'ru'}, {c:'ã‚Œ', r:'re'}, {c:'ã‚', r:'ro'},
            {c:'ã‚', r:'wa'}, {c:'ã‚’', r:'wo'}, {c:'ã‚“', r:'n'}
        ],
        katakana: [
            {c:'ã‚¢', r:'a'}, {c:'ã‚¤', r:'i'}, {c:'ã‚¦', r:'u'}, {c:'ã‚¨', r:'e'}, {c:'ã‚ª', r:'o'},
            {c:'ã‚«', r:'ka'}, {c:'ã‚­', r:'ki'}, {c:'ã‚¯', r:'ku'}, {c:'ã‚±', r:'ke'}, {c:'ã‚³', r:'ko'},
            {c:'ã‚µ', r:'sa'}, {c:'ã‚·', r:'shi'}, {c:'ã‚¹', r:'su'}, {c:'ã‚»', r:'se'}, {c:'ã‚½', r:'so'},
            {c:'ã‚¿', r:'ta'}, {c:'ãƒ', r:'chi'}, {c:'ãƒ„', r:'tsu'}, {c:'ãƒ†', r:'te'}, {c:'ãƒˆ', r:'to'},
            {c:'ãƒŠ', r:'na'}, {c:'ãƒ‹', r:'ni'}, {c:'ãƒŒ', r:'nu'}, {c:'ãƒ', r:'ne'}, {c:'ãƒ', r:'no'},
            {c:'ãƒ', r:'ha'}, {c:'ãƒ’', r:'hi'}, {c:'ãƒ•', r:'fu'}, {c:'ãƒ˜', r:'he'}, {c:'ãƒ›', r:'ho'},
            {c:'ãƒ', r:'ma'}, {c:'ãƒŸ', r:'mi'}, {c:'ãƒ ', r:'mu'}, {c:'ãƒ¡', r:'me'}, {c:'ãƒ¢', r:'mo'},
            {c:'ãƒ¤', r:'ya'}, {c:'ãƒ¦', r:'yu'}, {c:'ãƒ¨', r:'yo'},
            {c:'ãƒ©', r:'ra'}, {c:'ãƒª', r:'ri'}, {c:'ãƒ«', r:'ru'}, {c:'ãƒ¬', r:'re'}, {c:'ãƒ­', r:'ro'},
            {c:'ãƒ¯', r:'wa'}, {c:'ãƒ²', r:'wo'}, {c:'ãƒ³', r:'n'}
        ],
        advanced: [
            {c:'ãŒ', r:'ga'}, {c:'ã', r:'gi'}, {c:'ã', r:'gu'}, {c:'ã’', r:'ge'}, {c:'ã”', r:'go'},
            {c:'ã–', r:'za'}, {c:'ã˜', r:'ji'}, {c:'ãš', r:'zu'}, {c:'ãœ', r:'ze'}, {c:'ã', r:'zo'},
            {c:'ã ', r:'da'}, {c:'ã¢', r:'ji'}, {c:'ã¥', r:'zu'}, {c:'ã§', r:'de'}, {c:'ã©', r:'do'},
            {c:'ã°', r:'ba'}, {c:'ã³', r:'bi'}, {c:'ã¶', r:'bu'}, {c:'ã¹', r:'be'}, {c:'ã¼', r:'bo'},
            {c:'ã±', r:'pa'}, {c:'ã´', r:'pi'}, {c:'ã·', r:'pu'}, {c:'ãº', r:'pe'}, {c:'ã½', r:'po'},
            {c:'ãã‚ƒ', r:'kya'}, {c:'ã—ã‚ƒ', r:'sha'}, {c:'ã¡ã‚ƒ', r:'cha'}, {c:'ã«ã‚ƒ', r:'nya'}, 
            {c:'ã²ã‚ƒ', r:'hya'}, {c:'ã¿ã‚ƒ', r:'mya'}, {c:'ã‚Šã‚ƒ', r:'rya'},
            {c:'ã‚®ãƒ§', r:'gyo'}, {c:'ã‚¸ãƒ£', r:'ja'}, {c:'ãƒ“ãƒ¥', r:'byu'}, {c:'ãƒ”ãƒ§', r:'pyo'}
        ],
        // æ“´å……å¾Œçš„é¡Œåº«ï¼šç´„120å€‹å¸¸ç”¨è©å½™
        sentences: [
            // å•å€™
            { t: 'ã‚ã‚ŠãŒã¨ã†', m: 'è¬è¬', p: ['a', 'ri', 'ga', 'to', 'u'] },
            { t: 'ã“ã‚“ã«ã¡ã¯', m: 'ä½ å¥½ (åˆå®‰)', p: ['ko', 'n', 'ni', 'chi', 'ha'] },
            { t: 'ãŠã¯ã‚ˆã†', m: 'æ—©å®‰', p: ['o', 'ha', 'yo', 'u'] },
            { t: 'ã•ã‚ˆã†ãªã‚‰', m: 'å†è¦‹', p: ['sa', 'yo', 'u', 'na', 'ra'] },
            { t: 'ã™ã¿ã¾ã›ã‚“', m: 'ä¸å¥½æ„æ€', p: ['su', 'mi', 'ma', 'se', 'n'] },
            { t: 'ã”ã‚ã‚“ãªã•ã„', m: 'å°ä¸èµ·', p: ['go', 'me', 'n', 'na', 'sa', 'i'] },
            { t: 'ã¯ã˜ã‚ã¾ã—ã¦', m: 'åˆæ¬¡è¦‹é¢', p: ['ha', 'ji', 'me', 'ma', 'shi', 'te'] },
            { t: 'ãŠã­ãŒã„ã—ã¾ã™', m: 'éº»ç…©ä½ äº†/è«‹', p: ['o', 'ne', 'ga', 'i', 'shi', 'ma', 'su'] },
            
            // äººç‰©/ä»£åè©
            { t: 'ã‚ãŸã—', m: 'æˆ‘', p: ['wa', 'ta', 'shi'] },
            { t: 'ã‚ãªãŸ', m: 'ä½ ', p: ['a', 'na', 'ta'] },
            { t: 'ã›ã‚“ã›ã„', m: 'è€å¸«', p: ['se', 'n', 'se', 'i'] },
            { t: 'ãŒãã›ã„', m: 'å­¸ç”Ÿ', p: ['ga', 'ku', 'se', 'i'] },
            { t: 'ã¨ã‚‚ã ã¡', m: 'æœ‹å‹', p: ['to', 'mo', 'da', 'chi'] },
            { t: 'ã‹ãã', m: 'å®¶äºº', p: ['ka', 'zo', 'ku'] },
            { t: 'ãŠã¨ã†ã•ã‚“', m: 'çˆ¶è¦ª (æ•¬ç¨±)', p: ['o', 'to', 'u', 'sa', 'n'] },
            { t: 'ãŠã‹ã‚ã•ã‚“', m: 'æ¯è¦ª (æ•¬ç¨±)', p: ['o', 'ka', 'a', 'sa', 'n'] },
            { t: 'ã“ã©ã‚‚', m: 'å°å­©', p: ['ko', 'do', 'mo'] },
            { t: 'ãŠã¨ãª', m: 'å¤§äºº', p: ['o', 'to', 'na'] },

            // é£Ÿç‰©
            { t: 'ã”ã¯ã‚“', m: 'é£¯', p: ['go', 'ha', 'n'] },
            { t: 'ãƒ‘ãƒ³', m: 'éºµåŒ…', p: ['pa', 'n'] },
            { t: 'ã¿ãš', m: 'æ°´', p: ['mi', 'zu'] },
            { t: 'ãŠã¡ã‚ƒ', m: 'èŒ¶', p: ['o', 'cha'] },
            { t: 'ãã‚…ã†ã«ã‚…ã†', m: 'ç‰›å¥¶', p: ['gyu', 'u', 'nyu', 'u'] },
            { t: 'ã•ã‹ãª', m: 'é­š', p: ['sa', 'ka', 'na'] },
            { t: 'ã«ã', m: 'è‚‰', p: ['ni', 'ku'] },
            { t: 'ã‚„ã•ã„', m: 'è”¬èœ', p: ['ya', 'sa', 'i'] },
            { t: 'ãã ã‚‚ã®', m: 'æ°´æœ', p: ['ku', 'da', 'mo', 'no'] },
            { t: 'ã‚Šã‚“ã”', m: 'è˜‹æœ', p: ['ri', 'n', 'go'] },
            { t: 'ãŸã¾ã”', m: 'é›è›‹', p: ['ta', 'ma', 'go'] },
            { t: 'ãŠã„ã—ã„', m: 'å¥½åƒ', p: ['o', 'i', 'shi', 'i'] },
            { t: 'ã„ãŸã ãã¾ã™', m: 'é–‹å‹•äº†', p: ['i', 'ta', 'da', 'ki', 'ma', 'su'] },
            { t: 'ã”ã¡ãã†ã•ã¾', m: 'è¬è¬æ‹›å¾…', p: ['go', 'chi', 'so', 'u', 'sa', 'ma'] },

            // å‹•ç‰©
            { t: 'ã„ã¬', m: 'ç‹—', p: ['i', 'nu'] },
            { t: 'ã­ã“', m: 'è²“', p: ['ne', 'ko'] },
            { t: 'ã¨ã‚Š', m: 'é³¥', p: ['to', 'ri'] },
            { t: 'ã†ã•ã', m: 'å…”å­', p: ['u', 'sa', 'gi'] },
            { t: 'ã†ã¾', m: 'é¦¬', p: ['u', 'ma'] },
            
            // æ™‚é–“
            { t: 'ã„ã¾', m: 'ç¾åœ¨', p: ['i', 'ma'] },
            { t: 'ãã‚‡ã†', m: 'ä»Šå¤©', p: ['kyo', 'u'] },
            { t: 'ãã®ã†', m: 'æ˜¨å¤©', p: ['ki', 'no', 'u'] },
            { t: 'ã‚ã—ãŸ', m: 'æ˜å¤©', p: ['a', 'shi', 'ta'] },
            { t: 'ã‚ã•', m: 'æ—©ä¸Š', p: ['a', 'sa'] },
            { t: 'ã²ã‚‹', m: 'ä¸­åˆ', p: ['hi', 'ru'] },
            { t: 'ã°ã‚“', m: 'æ™šä¸Š', p: ['ba', 'n'] },
            { t: 'ã¾ã„ã«ã¡', m: 'æ¯å¤©', p: ['ma', 'i', 'ni', 'chi'] },

            // è‡ªç„¶/å ´æ‰€
            { t: 'ã‚„ã¾', m: 'å±±', p: ['ya', 'ma'] },
            { t: 'ã‹ã‚', m: 'æ²³å·', p: ['ka', 'wa'] },
            { t: 'ã†ã¿', m: 'æµ·', p: ['u', 'mi'] },
            { t: 'ãã‚‰', m: 'å¤©ç©º', p: ['so', 'ra'] },
            { t: 'ã‚ã‚', m: 'é›¨', p: ['a', 'me'] },
            { t: 'ã‚†ã', m: 'é›ª', p: ['yu', 'ki'] },
            { t: 'ã¯ãª', m: 'èŠ±', p: ['ha', 'na'] },
            { t: 'ã', m: 'æ¨¹', p: ['ki'] },
            { t: 'ã„ãˆ', m: 'å®¶', p: ['i', 'e'] },
            { t: 'ãŒã£ã“ã†', m: 'å­¸æ ¡', p: ['ga', 'kko', 'u'] },
            { t: 'ã¸ã‚„', m: 'æˆ¿é–“', p: ['he', 'ya'] },
            { t: 'ãƒˆã‚¤ãƒ¬', m: 'å»æ‰€', p: ['to', 'i', 're'] },

            // å½¢å®¹è©
            { t: 'ãŠãŠãã„', m: 'å¤§çš„', p: ['o', 'o', 'ki', 'i'] },
            { t: 'ã¡ã„ã•ã„', m: 'å°çš„', p: ['chi', 'i', 'sa', 'i'] },
            { t: 'ã‚ãŸã‚‰ã—ã„', m: 'æ–°çš„', p: ['a', 'ta', 'ra', 'shi', 'i'] },
            { t: 'ãµã‚‹ã„', m: 'èˆŠçš„', p: ['fu', 'ru', 'i'] },
            { t: 'ã‚ã¤ã„', m: 'ç†±çš„', p: ['a', 'tsu', 'i'] },
            { t: 'ã•ã‚€ã„', m: 'å†·çš„ (å¤©æ°£)', p: ['sa', 'mu', 'i'] },
            { t: 'ã„ã„', m: 'å¥½çš„', p: ['i', 'i'] },
            { t: 'ã‚ã‚‹ã„', m: 'å£çš„', p: ['wa', 'ru', 'i'] },
            { t: 'ãŠã‚‚ã—ã‚ã„', m: 'æœ‰è¶£çš„', p: ['o', 'mo', 'shi', 'ro', 'i'] },
            { t: 'ãŸã®ã—ã„', m: 'é–‹å¿ƒçš„', p: ['ta', 'no', 'shi', 'i'] },
            { t: 'ã‚€ãšã‹ã—ã„', m: 'å›°é›£çš„', p: ['mu', 'zu', 'ka', 'shi', 'i'] },
            { t: 'ã‚„ã•ã—ã„', m: 'ç°¡å–®çš„/æº«æŸ”çš„', p: ['ya', 'sa', 'shi', 'i'] },
            { t: 'ãŸã‹ã„', m: 'é«˜çš„/è²´çš„', p: ['ta', 'ka', 'i'] },
            { t: 'ã‚„ã™ã„', m: 'ä¾¿å®œçš„', p: ['ya', 'su', 'i'] },
            { t: 'ã™ã', m: 'å–œæ­¡', p: ['su', 'ki'] },
            { t: 'ãã‚‰ã„', m: 'è¨å­', p: ['ki', 'ra', 'i'] },
            { t: 'ãã‚Œã„', m: 'æ¼‚äº®/ä¹¾æ·¨', p: ['ki', 're', 'i'] },
            { t: 'ã’ã‚“ã', m: 'æœ‰ç²¾ç¥', p: ['ge', 'n', 'ki'] },

            // å‹•è©
            { t: 'ãŸã¹ã¾ã™', m: 'åƒ', p: ['ta', 'be', 'ma', 'su'] },
            { t: 'ã®ã¿ã¾ã™', m: 'å–', p: ['no', 'mi', 'ma', 'su'] },
            { t: 'ã¿ã¾ã™', m: 'çœ‹', p: ['mi', 'ma', 'su'] },
            { t: 'ããã¾ã™', m: 'è½', p: ['ki', 'ki', 'ma', 'su'] },
            { t: 'ã„ãã¾ã™', m: 'å»', p: ['i', 'ki', 'ma', 'su'] },
            { t: 'ãã¾ã™', m: 'ä¾†', p: ['ki', 'ma', 'su'] },
            { t: 'ã‹ãˆã‚Šã¾ã™', m: 'å›å®¶', p: ['ka', 'e', 'ri', 'ma', 'su'] },
            { t: 'ã‹ã„ã¾ã™', m: 'è²·', p: ['ka', 'i', 'ma', 'su'] },
            { t: 'ã‚ˆã¿ã¾ã™', m: 'è®€', p: ['yo', 'mi', 'ma', 'su'] },
            { t: 'ã‹ãã¾ã™', m: 'å¯«', p: ['ka', 'ki', 'ma', 'su'] },
            { t: 'ã¯ãªã—ã¾ã™', m: 'èªªè©±', p: ['ha', 'na', 'shi', 'ma', 'su'] },
            { t: 'ã­ã¾ã™', m: 'ç¡è¦º', p: ['ne', 'ma', 'su'] },
            { t: 'ãŠãã¾ã™', m: 'èµ·åºŠ', p: ['o', 'ki', 'ma', 'su'] },
            { t: 'ã‚ãã³ã¾ã™', m: 'ç©', p: ['a', 'so', 'bi', 'ma', 'su'] },
            { t: 'ã¹ã‚“ãã‚‡ã†', m: 'å­¸ç¿’', p: ['be', 'n', 'kyo', 'u'] },
            
            // èº«é«”
            { t: 'ã‚ãŸã¾', m: 'é ­', p: ['a', 'ta', 'ma'] },
            { t: 'ã‚', m: 'çœ¼ç›', p: ['me'] },
            { t: 'ã¿ã¿', m: 'è€³æœµ', p: ['mi', 'mi'] },
            { t: 'ãã¡', m: 'å˜´å·´', p: ['ku', 'chi'] },
            { t: 'ã¦', m: 'æ‰‹', p: ['te'] },
            { t: 'ã‚ã—', m: 'è…³', p: ['a', 'shi'] },

            // ç‰©å“
            { t: 'ã»ã‚“', m: 'æ›¸', p: ['ho', 'n'] },
            { t: 'ã˜ã—ã‚‡', m: 'å­—å…¸', p: ['ji', 'sho'] },
            { t: 'ãˆã‚“ã´ã¤', m: 'é‰›ç­†', p: ['e', 'n', 'pi', 'tsu'] },
            { t: 'ã‹ã•', m: 'å‚˜', p: ['ka', 'sa'] },
            { t: 'ã‹ã°ã‚“', m: 'åŒ…åŒ…', p: ['ka', 'ba', 'n'] },
            { t: 'ã¨ã‘ã„', m: 'æ™‚é˜/æ‰‹éŒ¶', p: ['to', 'ke', 'i'] },
            { t: 'ãã‚‹ã¾', m: 'è»Š', p: ['ku', 'ru', 'ma'] },
            { t: 'ã§ã‚“ã—ã‚ƒ', m: 'é›»è»Š', p: ['de', 'n', 'sha'] },
            { t: 'ãŠé‡‘', m: 'éŒ¢', p: ['o', 'ka', 'ne'] }, // ãŠã‹ã­
        ]
    };

    // --- éŠæˆ²é‚è¼¯ ---
    const game = {
        totalQuestions: 10,
        currentQIndex: 0,
        score: 0,
        mode: 'easy', 
        questions: [],
        isAnswering: false,
        
        // æ‹¼å­—æ¨¡å¼çš„ç‹€æ…‹
        currentAnswer: [],
        targetAnswer: [],

        start: function(level) {
            this.mode = level;
            this.score = 0;
            this.currentQIndex = 0;
            this.questions = this.generateQuestions(level);
            
            document.getElementById('score-current').innerText = '0';
            let label = 'åˆç´š';
            if(level === 'medium') label = 'ä¸­ç´š';
            if(level === 'hard') label = 'ä¸Šç´š';
            if(level === 'sentence') label = 'å¯¦æˆ° â€¢ è©å½™';
            document.getElementById('label-mode').innerText = label;
            
            // åˆ‡æ›å°æ‡‰çš„ DOM é¡¯ç¤º
            if (level === 'sentence') {
                document.getElementById('wrapper-single').classList.remove('active');
                document.getElementById('options-box').classList.remove('active');
                document.getElementById('wrapper-sentence').classList.add('active');
            } else {
                document.getElementById('wrapper-single').classList.add('active');
                document.getElementById('options-box').classList.add('active');
                document.getElementById('wrapper-sentence').classList.remove('active');
            }

            ui.showScreen('game');
            this.nextQuestion();
        },

        generateQuestions: function(level) {
            let pool = [];
            
            if (level === 'sentence') {
                pool = [...KANA_DATA.sentences];
                pool.sort(() => Math.random() - 0.5);
                return pool.slice(0, this.totalQuestions);
            }

            if (level === 'easy') pool = [...KANA_DATA.hiragana];
            else if (level === 'medium') pool = [...KANA_DATA.katakana];
            else pool = [...KANA_DATA.hiragana, ...KANA_DATA.katakana, ...KANA_DATA.advanced];
            
            pool.sort(() => Math.random() - 0.5);
            return pool.slice(0, this.totalQuestions).map(q => {
                let distractors = pool.filter(x => x.r !== q.r);
                distractors.sort(() => Math.random() - 0.5);
                let options = [q, ...distractors.slice(0, 3)];
                options.sort(() => Math.random() - 0.5);
                return { question: q, options: options };
            });
        },

        nextQuestion: function() {
            if (this.currentQIndex >= this.totalQuestions) {
                this.end();
                return;
            }

            this.isAnswering = false;
            
            // é‡ç½®åé¥‹èˆ‡æç¤º
            const feedback = document.getElementById('feedback-icon');
            feedback.className = 'feedback-overlay';
            feedback.style.opacity = '0';
            feedback.style.transform = 'translate(-50%, -50%) scale(0)';
            
            document.getElementById('correction-box').classList.remove('visible');

            // é€²åº¦æ¢
            const progress = (this.currentQIndex / this.totalQuestions) * 100;
            document.getElementById('progress-bar').style.width = progress + '%';

            if (this.mode === 'sentence') {
                this.renderSentenceQuestion();
            } else {
                this.renderNormalQuestion();
            }
        },

        // æœ—è®€åŠŸèƒ½
        speakCurrent: function() {
            let textToSpeak = '';
            const qData = this.questions[this.currentQIndex];

            if (this.mode === 'sentence') {
                textToSpeak = qData.t; // å¿µæ—¥æ–‡å¥å­
            } else {
                textToSpeak = qData.question.c; // å¿µå‡å
            }

            if ('speechSynthesis' in window) {
                // å–æ¶ˆä¹‹å‰çš„ç™¼éŸ³
                window.speechSynthesis.cancel();

                const utterance = new SpeechSynthesisUtterance(textToSpeak);
                utterance.lang = 'ja-JP';
                utterance.rate = 0.9; // ç¨å¾®æ…¢ä¸€é»é»
                
                // å˜—è©¦å°‹æ‰¾æ—¥æ–‡èªéŸ³
                const voices = window.speechSynthesis.getVoices();
                const jpVoice = voices.find(v => v.lang.includes('ja') || v.lang.includes('JP'));
                if (jpVoice) utterance.voice = jpVoice;

                window.speechSynthesis.speak(utterance);
            } else {
                console.log("ç€è¦½å™¨ä¸æ”¯æ´ç™¼éŸ³ API");
            }
        },

        // æ¸²æŸ“ä¸€èˆ¬æ¨¡å¼
        renderNormalQuestion: function() {
            const qData = this.questions[this.currentQIndex];
            document.getElementById('q-char').innerText = qData.question.c;
            
            const optionsBox = document.getElementById('options-box');
            optionsBox.innerHTML = '';

            qData.options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerText = opt.r;
                btn.onclick = () => this.checkAnswer(opt.r, qData.question.r);
                optionsBox.appendChild(btn);
            });
        },

        // æ¸²æŸ“æ‹¼å­—æ¨¡å¼
        renderSentenceQuestion: function() {
            const qData = this.questions[this.currentQIndex];
            this.targetAnswer = [...qData.p];
            this.currentAnswer = [];
            
            document.getElementById('s-kana').innerText = qData.t;
            document.getElementById('s-meaning').innerText = qData.m;
            
            const answerArea = document.getElementById('s-answer-area');
            const poolArea = document.getElementById('s-pool');
            answerArea.innerHTML = '';
            poolArea.innerHTML = '';

            // ç”Ÿæˆäº‚åºé¸é …
            let shuffledParts = qData.p.map((part, index) => ({ val: part, id: index }));
            shuffledParts.sort(() => Math.random() - 0.5);

            shuffledParts.forEach(item => {
                const chip = document.createElement('div');
                chip.className = 'word-chip';
                chip.innerText = item.val;
                chip.dataset.val = item.val;
                chip.dataset.id = item.id;
                
                chip.onclick = () => this.addWordPart(chip, item);
                poolArea.appendChild(chip);
            });
        },

        addWordPart: function(chipElement, itemData) {
            if (this.isAnswering) return;
            
            this.currentAnswer.push(itemData.val);
            chipElement.classList.add('used');

            const ansChip = document.createElement('button');
            ansChip.className = 'answer-chip';
            ansChip.innerText = itemData.val;
            ansChip.onclick = () => this.removeWordPart(ansChip, chipElement, itemData.val);
            
            document.getElementById('s-answer-area').appendChild(ansChip);

            if (this.currentAnswer.length === this.targetAnswer.length) {
                this.checkSentenceAnswer();
            }
        },

        removeWordPart: function(ansChip, originalChip, val) {
            if (this.isAnswering) return;
            ansChip.remove();
            originalChip.classList.remove('used');
            const idx = this.currentAnswer.lastIndexOf(val);
            if (idx > -1) this.currentAnswer.splice(idx, 1);
        },

        checkSentenceAnswer: function() {
            this.isAnswering = true;
            const isCorrect = JSON.stringify(this.currentAnswer) === JSON.stringify(this.targetAnswer);
            
            this.showFeedback(isCorrect, this.targetAnswer.join(' - '));
        },

        checkAnswer: function(selected, correct) {
            if (this.isAnswering) return;
            this.isAnswering = true;
            const isCorrect = selected === correct;
            
            this.showFeedback(isCorrect, correct);
        },

        showFeedback: function(isCorrect, correctText) {
            const feedback = document.getElementById('feedback-icon');
            
            if (isCorrect) {
                this.score += 10;
                feedback.classList.add('correct');
                feedback.classList.remove('wrong');
                // ç­”å°ä¹Ÿæ’­æ”¾èªéŸ³ (å¯é¸)
                // this.speakCurrent(); 
            } else {
                feedback.classList.add('wrong');
                feedback.classList.remove('correct');
                
                // é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆ
                const correctionBox = document.getElementById('correction-box');
                document.getElementById('correction-text').innerText = correctText;
                correctionBox.classList.add('visible');
                
                // ç­”éŒ¯æ™‚è‡ªå‹•æœ—è®€æ­£ç¢ºç™¼éŸ³
                this.speakCurrent();
            }

            requestAnimationFrame(() => {
                feedback.style.opacity = '1';
                feedback.style.transform = 'translate(-50%, -50%) scale(1)';
            });

            document.getElementById('score-current').innerText = this.score;

            // æ ¹æ“šç­”å°æˆ–ç­”éŒ¯èª¿æ•´ç­‰å¾…æ™‚é–“
            const waitTime = isCorrect ? 800 : 2500; // ç­”éŒ¯ç­‰ 2.5 ç§’çœ‹ç­”æ¡ˆ

            setTimeout(() => {
                this.currentQIndex++;
                this.nextQuestion();
            }, waitTime);
        },

        end: function() {
            ui.showScreen('result');
            
            let displayScore = 0;
            const finalScoreEl = document.getElementById('score-final');
            const rankTextEl = document.getElementById('rank-text');
            
            const timer = setInterval(() => {
                if (displayScore >= this.score) {
                    clearInterval(timer);
                    displayScore = this.score;
                } else {
                    displayScore++;
                }
                finalScoreEl.innerText = displayScore;
            }, 20);

            if (this.score === 100) rankTextEl.innerText = "å…è¨±çš†å‚³ï¼(å®Œç¾)";
            else if (this.score >= 80) rankTextEl.innerText = "å¤§å¤‰ã‚ˆãã§ãã¾ã—ãŸï¼";
            else if (this.score >= 60) rankTextEl.innerText = "ã‚ˆãã§ãã¾ã—ãŸã€‚";
            else rankTextEl.innerText = "é ‘å¼µã£ã¦ãã ã•ã„ï¼";
        }
    };

    // --- UI æ§åˆ¶ ---
    const ui = {
        showScreen: function(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-' + id).classList.add('active');
        },
        
        initSakura: function() {
            const container = document.getElementById('sakura-container');
            const sakuraCount = 10; 
            
            for(let i=0; i<sakuraCount; i++) {
                let el = document.createElement('div');
                el.className = 'sakura';
                el.style.left = Math.random() * 100 + '%';
                el.style.animationDuration = (Math.random() * 5 + 5) + 's';
                el.style.animationDelay = (Math.random() * 5) + 's';
                container.appendChild(el);
            }
        }
    };

    window.onload = () => {
        ui.initSakura();
        
        // é å…ˆè¼‰å…¥èªéŸ³åˆ—è¡¨ (è§£æ±ºæŸäº›ç€è¦½å™¨ç¬¬ä¸€æ¬¡æ²’è²éŸ³çš„å•é¡Œ)
        if ('speechSynthesis' in window) {
            window.speechSynthesis.getVoices();
        }
    };

</script>
</body>
</html>
